# Конфигурация

## Конфигурация окружения

Фреймворк поддерживает конфигурирование зависимое от окружения выполнения. Для реализации этого Joke использует
.env-файлы.

### Определение текущего окружения

Текущее окружение определяется из источников (в порядке приоритета):

- $_ENV['JK_ENV']
- $_SERVER['JK_ENV']
- getenv('JK_ENV')

В случае, если данная переменная не задана, текущее окружение считается 'local'

### Стандартные наименования окружений

В фреймворке определены стандартные наименования для некоторых окружений

- Environment::ENV_PRODUCTION = 'production' - продуктовое окружение
- Environment::ENV_DEVELOPMENT = 'development' - окружение для разработки
- Environment::ENV_TESTING = 'testing' - тестовое окружение
- Environment::ENV_LOCAL = 'local' - окружение по умолчанию

### Порядок загрузки .env-файлов

1. `.env` - базовый файл, общий для всех окружений
2. `.env.{JK_ENV}` - файл, специфичный для текущего окружения (.env.local, .env.production), кроме .env.local
3. `.env.local` - файл для локальных переопределений, который всегда загружается последним (и перезаписывает любые
   значения), кроме случая, когда текущее окружение — testing.

> Важно!  
> Файлы загружаются последовательно, и последующие перезаписывают значения из предыдущих

> Важно!!!
> Никогда не коммитьте .env.local или .env с секретами в систему контроля версий! Используйте .env.example как шаблон
> для новых разработчиков

### Поддерживаемые типы значений

| Запись в .env файлe  | Интерпретация            |
|----------------------|--------------------------|
| `PROP=1`             | целое число              |
| `PROP=1.2`           | число с плавающей точкой |
| `PROP=1e2`           | число с плавающей точкой |
| `PROP=1E2`           | число с плавающей точкой |
| `PROP=1.1.1.1`       | строка                   |
| `PROP=true`          | boolean, true            |
| `PROP=false`         | boolean, false           |
| `PROP=null`          | null                     |
| `PROP=`              | null                     |
| `PROP`               | null                     |
| `PROP=Hello world`   | строка                   |
| `PROP="Hello world"` | строка                   |
| `PROP='Hello world'` | строка                   |

В строках обрамленных кавычками допустимо экранирование
`PROP="Hello \"world\""` - переменная будет иметь значение `Hello "world"`
`PROP='Hello \'world\''` - переменная будет иметь значение `Hello 'world'`

## Конфигурационные файлы

Помимо переменных окружения, фреймворк Joke использует **конфигурационные файлы** для хранения структурированных
настроек приложения. Эти файлы дополняют `.env` и позволяют организовать сложные настройки в удобном виде.

### Расположение и формат

Конфигурационные файлы представляют собой обычные PHP-файлы, возвращающие ассоциативный массив. Они располагаются в
директории `config/` (или другой, указанной при инициализации) и имеют расширение `.php`.

Пример файла `config/database.php`:

```php
<?php
/**
* @var \Vasoft\Joke\Config\Environment $env 
*/
return [
    'default' => $env->get('DB_CONNECTION', 'mysql'),
    'connections' => [
        'mysql' => [
            'host' => $env->get('DB_HOST','127.0.0.1'),
            'port' => (int)($env->get('DB_PORT', 3306)),
            'database' => $env->get('DB_DATABASE', 'forge'),
            'username' => $env->get('DB_USERNAME', 'forge'),
            'password' => $env->get('DB_PASSWORD', ''),
        ],
    ],
];
```

> **Важно!**  
> Конфигурационные файлы **должны возвращать только массивы**. Допустимые типы значений: `null`, `int`, `float`,
>`string`, `bool`, `array`.

> **Доступ к переменным окружения**  
> В конфигурационных файлах доступен экземпляр класса Environment через переменную $env. Это позволяет безопасно
> получать значения из .env файлов без загрязнения глобального пространства имён.

### Базовые и ленивые конфигурации

Фреймворк поддерживает два типа конфигураций:

- **Базовые конфигурации** — загружаются при старте приложения. Обычно это критически важные настройки: `app`,
  `database`, `logging`.
- **Ленивые конфигурации** — загружаются по требованию, когда к ним происходит первое обращение. Используются для
  модульных или редко используемых настроек.

Это позволяет оптимизировать время запуска приложения, загружая только необходимые конфигурации.

### Доступ к конфигурации

Для получения значений конфигурации используется класс `Config` с поддержкой **точечной нотации**:

```php
// Получить значение с дефолтом
$host = $config->get('database.connections.mysql.host', 'localhost');

// Получить значение или выбросить исключение
$database = $config->getOrFail('database.connections.mysql.database');
```

Точечная нотация разделяет путь на две части:

- **Первая часть** (`database`) — имя конфигурационного файла (без расширения `.php`)
- **Последующие части** (`connections.mysql.host`) — путь внутри конфигурационного массива

### Интеграция с переменными окружения

Конфигурационные файлы **активно используют переменные окружения** из `.env`-файлов. Это позволяет:

- Хранить чувствительные данные (пароли, ключи API) вне кодовой базы
- Иметь разные настройки для разных окружений
- Поддерживать одинаковую структуру конфигурации при разных значениях

Рекомендуемый подход:

- В `.env` файлах хранить **значения**, специфичные для окружения
- В конфигурационных файлах определять **структуру** и **логику преобразования** переменных окружения

### Пример полного workflow

1. Приложение определяет окружение (`JK_ENV=production`)
2. Загружаются `.env` файлы в порядке: `.env` → `.env.production` → `.env.local`
3. Инициализируется `ConfigLoader` с путями к конфигурациям
4. При первом обращении к `$config->get('app.name')`:
    - Загружается базовый конфиг `config/app.php`
    - Возвращается значение `$env->get('APP_NAME', 'Joke Application')`
5. При обращении к `$config->get('payment.gateways')`:
    - Конфиг `payment.php` отсутствует в базовых
    - Происходит ленивая загрузка из зарегистрированных ленивых путей
    - Результат кэшируется для последующих обращений
